<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>混凝土澆置回報 App (Gemini智慧版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        /* Modal樣式 */
        .modal-hidden {
            display: none;
        }
        /* 載入中動畫 */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-md bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-8 space-y-5">
        <!-- 標題 -->
        <div class="text-center">
            <h1 class="text-2xl md:text-3xl font-bold text-cyan-400">混凝土澆置回報</h1>
            <p class="text-gray-400 mt-1" id="date-display">114年7月14日</p>
        </div>

        <!-- 資訊卡片 -->
        <div class="bg-gray-700/50 p-5 rounded-lg space-y-3">
            <div class="flex justify-between items-center">
                <span class="text-gray-400 text-sm">澆置位置</span>
                <span id="location" class="font-semibold text-right">8F柱牆 / 9F樑板區</span>
            </div>
            <hr class="border-gray-600">
            <div class="flex justify-between items-center">
                <span class="text-gray-400 text-sm">本日預計總數</span>
                <span id="total-estimate" class="font-semibold">625 M³</span>
            </div>
        </div>

        <!-- 動態更新區域 -->
        <div class="space-y-4">
            <div class="bg-gray-700/50 p-4 rounded-lg">
                <label for="m3-per-truck" class="block text-sm font-medium text-gray-400 mb-2">設定每車平均方數 (M³)</label>
                <input type="number" id="m3-per-truck" value="5.5" class="w-full bg-gray-800 border border-gray-600 rounded-md p-2 text-center text-white font-bold text-lg focus:ring-2 focus:ring-cyan-500 focus:outline-none">
            </div>

            <div class="grid grid-cols-2 gap-4 text-center">
                <div class="bg-gray-900 p-4 rounded-lg flex flex-col items-center justify-center">
                    <p class="text-sm text-gray-400">累積出車 (可點擊修改)</p>
                    <input type="number" id="truck-count-input" value="0" class="w-full bg-transparent text-4xl font-bold text-amber-400 text-center focus:outline-none p-0 m-0 border-0">
                    <p class="text-sm text-gray-400">車</p>
                </div>
                <div class="bg-gray-900 p-4 rounded-lg">
                    <p class="text-sm text-gray-400">累積澆置數量</p>
                    <p id="volume-count" class="text-4xl font-bold text-green-400">0.0</p>
                    <p class="text-sm text-gray-400">M³</p>
                </div>
            </div>
             <div class="bg-gray-700/50 p-4 rounded-lg">
                <label for="special-notes" class="block text-sm font-medium text-gray-400 mb-2">今日特殊記事 (選填)</label>
                <textarea id="special-notes" rows="2" class="w-full bg-gray-800 border border-gray-600 rounded-md p-2 text-white focus:ring-2 focus:ring-cyan-500 focus:outline-none" placeholder="例如：天氣炎熱、下午有雷陣雨..."></textarea>
            </div>
        </div>

        <!-- 操作按鈕 -->
        <div>
            <button id="gemini-generate-btn" class="w-full bg-gradient-to-r from-purple-500 to-cyan-500 hover:from-purple-600 hover:to-cyan-600 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-2 transition-transform transform active:scale-95">
                <span id="gemini-btn-text">✨ 產生智慧工務日報</span>
                <div id="gemini-loader" class="loader modal-hidden"></div>
            </button>
        </div>
    </div>

    <!-- Gemini 結果 Modal -->
    <div id="gemini-modal" class="modal-hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-gray-800 rounded-2xl shadow-2xl p-6 w-full max-w-lg max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-cyan-400">智慧工務日報</h2>
                <button id="close-modal-btn" class="text-gray-400 hover:text-white">&times;</button>
            </div>
            <div id="gemini-result-container" class="flex-grow bg-gray-900/70 p-4 rounded-lg overflow-y-auto whitespace-pre-wrap">
                <!-- Gemini 生成的內容會放在這裡 -->
            </div>
            <div class="mt-4 flex gap-4">
                <button id="copy-gemini-report-btn" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg">複製內容</button>
            </div>
        </div>
    </div>


    <script>
        // DOM 元素
        const truckCountInput = document.getElementById('truck-count-input');
        const volumeCountEl = document.getElementById('volume-count');
        const m3PerTruckInput = document.getElementById('m3-per-truck');
        const geminiGenerateBtn = document.getElementById('gemini-generate-btn');
        const geminiBtnText = document.getElementById('gemini-btn-text');
        const geminiLoader = document.getElementById('gemini-loader');
        const geminiModal = document.getElementById('gemini-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const geminiResultContainer = document.getElementById('gemini-result-container');
        const copyGeminiReportBtn = document.getElementById('copy-gemini-report-btn');
        const specialNotesInput = document.getElementById('special-notes');

        // 更新顯示的函數
        function updateDisplay() {
            let truckCount = parseInt(truckCountInput.value, 10) || 0;
            if (truckCount < 0) {
                truckCount = 0;
                truckCountInput.value = 0;
            }
            const m3PerTruck = parseFloat(m3PerTruckInput.value) || 0;
            const volumeCount = truckCount * m3PerTruck;

            volumeCountEl.textContent = volumeCount.toFixed(1);
        }
        
        m3PerTruckInput.addEventListener('input', updateDisplay);
        truckCountInput.addEventListener('input', updateDisplay);

        // --- Gemini API 相關功能 ---

        // API 呼叫函數 (包含指數退避重試)
        async function callGeminiAPI(prompt, retries = 3, delay = 1000) {
            const apiKey = ""; // API金鑰留空，由Canvas環境提供
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{
                    role: "user",
                    parts: [{ text: prompt }]
                }],
                generationConfig: {
                    temperature: 0.5,
                    topK: 1,
                    topP: 1,
                    maxOutputTokens: 512,
                }
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    // 如果是可重試的錯誤碼 (如 429 Too Many Requests)，則進行重試
                    if ((response.status === 429 || response.status >= 500) && retries > 0) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return callGeminiAPI(prompt, retries - 1, delay * 2);
                    }
                    throw new Error(`API 請求失敗，狀態碼: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    // 處理API回傳但內容為空的情況
                    console.warn("API 回應結構異常或內容為空:", result);
                    // 檢查是否有 block reason
                    const blockReason = result?.candidates?.[0]?.finishReason;
                    if (blockReason === 'SAFETY') {
                        return "內容因安全設定被阻擋。請調整您的輸入文字後再試一次。";
                    }
                    return "無法生成日報，API 回應格式不符預期。";
                }

            } catch (error) {
                console.error('呼叫 Gemini API 時發生錯誤:', error);
                if (retries > 0) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return callGeminiAPI(prompt, retries - 1, delay * 2);
                }
                return `生成日報時發生錯誤: ${error.message}。請檢查網路連線後再試。`;
            }
        }


        // 點擊生成按鈕的事件
        geminiGenerateBtn.addEventListener('click', async () => {
            geminiBtnText.classList.add('modal-hidden');
            geminiLoader.classList.remove('modal-hidden');
            geminiGenerateBtn.disabled = true;

            // 1. 收集資訊
            const date = document.getElementById('date-display').textContent;
            const location = document.getElementById('location').textContent;
            const totalEstimate = document.getElementById('total-estimate').textContent;
            const currentTrucks = truckCountInput.value;
            const currentVolume = volumeCountEl.textContent;
            const specialNotes = specialNotesInput.value.trim();

            // 2. 建立 Prompt
            const prompt = `
                請扮演一位專業的營造工地主任，根據以下本日的混凝土澆置資訊，撰寫一份精簡、專業的繁體中文工務日報。
                日報內容需要包含：
                1.  今日完成事項的總結。
                2.  自然地融入「特殊記事」的內容（如果有的話）。
                3.  根據今日的澆置進度（目前完成方數與預計總方數的比較），簡要規劃明日的重點工作。如果已完成，可以規劃養護或拆模工作；如果未完成，則規劃繼續完成剩餘部分。

                [本日資訊]
                - 日期: ${date}
                - 澆置位置: ${location}
                - 本日預計總數: ${totalEstimate}
                - 累積出車: ${currentTrucks} 車
                - 累積澆置數量: ${currentVolume} M³
                - 特殊記事: ${specialNotes || "無"}

                請直接輸出日報內容，文字力求通順專業，無需加上「工務日報」標題。
            `;
            
            // 3. 呼叫 API
            const report = await callGeminiAPI(prompt);

            // 4. 顯示結果
            geminiResultContainer.textContent = report;
            geminiModal.classList.remove('modal-hidden');

            geminiBtnText.classList.remove('modal-hidden');
            geminiLoader.classList.add('modal-hidden');
            geminiGenerateBtn.disabled = false;
        });

        // 關閉 Modal
        closeModalBtn.addEventListener('click', () => {
            geminiModal.classList.add('modal-hidden');
        });

        // 複製 Gemini 結果
        copyGeminiReportBtn.addEventListener('click', () => {
            const reportText = geminiResultContainer.textContent;
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = reportText;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            
            try {
                document.execCommand('copy');
                const originalText = copyGeminiReportBtn.textContent;
                copyGeminiReportBtn.textContent = '已複製！';
                setTimeout(() => {
                    copyGeminiReportBtn.textContent = originalText;
                }, 2000);
            } catch (err) {
                console.error('複製失敗: ', err);
                const originalText = copyGeminiReportBtn.textContent;
                copyGeminiReportBtn.textContent = '複製失敗';
                 setTimeout(() => {
                    copyGeminiReportBtn.textContent = originalText;
                }, 2000);
            }
            
            document.body.removeChild(tempTextArea);
        });


        // 頁面載入時初始化
        updateDisplay();
    </script>

</body>
</html>
