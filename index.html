<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>混凝土澆置回報 App (完整日報版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        input[type="date"]::-webkit-calendar-picker-indicator,
        input[type="time"]::-webkit-calendar-picker-indicator {
            cursor: pointer;
            filter: invert(0.8) brightness(100%);
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1f2937;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        /* 鎖定時的樣式 */
        .info-locked .info-input {
            padding-top: 0.25rem;
            padding-bottom: 0.25rem;
            background-color: #374151; /* bg-gray-700 */
        }
        .info-locked > div {
             margin-bottom: 0.5rem; /* 縮小間距 */
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-md bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-8 flex flex-col h-[95vh] max-h-[900px]">
        <!-- 標題 -->
        <div class="text-center mb-4">
            <h1 class="text-2xl md:text-3xl font-bold text-cyan-400">混凝土澆置回報</h1>
        </div>
        
        <!-- 主要資訊輸入欄 -->
        <div class="relative bg-gray-700/50 p-4 rounded-lg space-y-4 mb-4 transition-all duration-300" id="main-info-section">
            <button id="toggle-info-lock-btn" class="absolute top-3 right-3 text-gray-400 hover:text-white p-1 rounded-full">
                <!-- SVG 圖示會由 JS 切換 -->
            </button>
            <div>
                <label for="report-date" class="text-sm text-gray-400">日期</label>
                <input type="date" id="report-date" class="info-input mt-1 bg-gray-800 border-gray-600 text-white text-base rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block w-full p-2 font-semibold transition-all duration-300">
            </div>
            <div>
                <label for="location" class="text-sm text-gray-400">澆置位置</label>
                <input type="text" id="location" value="8F柱牆 / 9F樑板區" class="info-input mt-1 bg-gray-800 border-gray-600 text-white text-base rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block w-full p-2 font-semibold transition-all duration-300">
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label for="start-time" class="text-sm text-gray-400">開始時間</label>
                    <input type="time" id="start-time" class="info-input mt-1 bg-gray-800 border-gray-600 text-white text-base rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block w-full p-2 font-semibold transition-all duration-300">
                </div>
                <div>
                    <label for="estimated-total" class="text-sm text-gray-400">預計總數 (M³)</label>
                    <input type="number" id="estimated-total" value="625" class="info-input mt-1 bg-gray-800 border-gray-600 text-white text-base rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block w-full p-2 font-semibold transition-all duration-300">
                </div>
            </div>
             <div class="grid grid-cols-2 gap-4">
                <div>
                    <label for="end-time" class="text-sm text-gray-400">完成時間 (選填)</label>
                    <input type="time" id="end-time" class="info-input mt-1 bg-gray-800 border-gray-600 text-white text-base rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block w-full p-2 font-semibold transition-all duration-300">
                </div>
                <div id="actual-total-container" class="hidden">
                    <label class="text-sm text-gray-400">實際總數 (M³)</label>
                    <p id="actual-total" class="mt-1 bg-gray-900 text-green-400 text-base rounded-lg block w-full p-2 font-bold h-[42px] flex items-center"></p>
                </div>
            </div>
        </div>

        <!-- 總計數據 -->
        <div class="grid grid-cols-2 gap-4 text-center mb-4">
            <div class="bg-gray-900 p-4 rounded-lg">
                <p class="text-sm text-gray-400">累積出車</p>
                <p id="total-trucks" class="text-3xl font-bold text-amber-400">0</p>
            </div>
            <div class="bg-gray-900 p-4 rounded-lg">
                <p class="text-sm text-gray-400">累積澆置數量</p>
                <p id="total-volume" class="text-3xl font-bold text-green-400">0.0</p>
            </div>
        </div>

        <!-- 新增車次按鈕 -->
        <div class="mb-4">
            <button id="add-truck-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-transform transform active:scale-95 flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0-0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>
                新增一車紀錄
            </button>
        </div>

        <!-- 車次列表 -->
        <div id="truck-list-container" class="flex-grow bg-gray-900/50 p-3 rounded-lg overflow-y-auto custom-scrollbar space-y-2 min-h-[150px]"></div>

        <!-- 底部操作按鈕 -->
        <div class="mt-4 pt-4 border-t border-gray-700 grid grid-cols-2 gap-4">
            <button id="reset-all" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg">全部重設</button>
            <button id="copy-report-btn" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" /><path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2H6zM8 7a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1zm-1 4a1 1 0 100 2h4a1 1 0 100-2H7z" /></svg>
                <span id="copy-text">複製回報</span>
            </button>
        </div>
    </div>

    <!-- 複製預覽 Modal -->
    <div id="copy-preview-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50" style="display: none;">
        <div class="bg-gray-800 rounded-2xl shadow-2xl p-6 w-full max-w-lg max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-cyan-400">回報內容預覽</h2>
                <button id="close-modal-btn" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <pre id="report-preview-content" class="flex-grow bg-gray-900/70 p-4 rounded-lg overflow-y-auto whitespace-pre-wrap text-white"></pre>
            <div class="mt-4 flex gap-4">
                 <button id="cancel-copy-btn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">取消</button>
                <button id="confirm-copy-btn" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg">確認複製</button>
            </div>
        </div>
    </div>

    <script>
        // DOM 元素
        const mainInfoSection = document.getElementById('main-info-section');
        const toggleLockBtn = document.getElementById('toggle-info-lock-btn');
        const reportDateEl = document.getElementById('report-date');
        const locationEl = document.getElementById('location');
        const startTimeEl = document.getElementById('start-time');
        const estimatedTotalEl = document.getElementById('estimated-total');
        const endTimeEl = document.getElementById('end-time');
        const actualTotalContainer = document.getElementById('actual-total-container');
        const actualTotalEl = document.getElementById('actual-total');
        const addTruckBtn = document.getElementById('add-truck-btn');
        const truckListContainer = document.getElementById('truck-list-container');
        const totalTrucksEl = document.getElementById('total-trucks');
        const totalVolumeEl = document.getElementById('total-volume');
        const copyBtn = document.getElementById('copy-report-btn');
        const copyTextEl = document.getElementById('copy-text');
        const resetBtn = document.getElementById('reset-all');
        const copyPreviewModal = document.getElementById('copy-preview-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const cancelCopyBtn = document.getElementById('cancel-copy-btn');
        const confirmCopyBtn = document.getElementById('confirm-copy-btn');
        const reportPreviewContent = document.getElementById('report-preview-content');

        let truckCounter = 0;
        let isInfoLocked = false;

        const lockIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>`;
        const unlockIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z" /></svg>`;

        // --- 初始化函數 ---
        function initializeApp() {
            setTodayDate();
            toggleLockBtn.innerHTML = unlockIcon;
            startTimeEl.addEventListener('click', setNowTime, { once: true });
        }
        
        function setTodayDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            reportDateEl.value = `${year}-${month}-${day}`;
        }

        function setNowTime(event) {
             if (!event.target.value) {
                const now = new Date();
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                event.target.value = `${hours}:${minutes}`;
            }
        }

        // --- 更新總計數據 ---
        function updateTotals() {
            const allTruckInputs = truckListContainer.querySelectorAll('.truck-volume-input');
            let currentTotalVolume = 0;
            allTruckInputs.forEach(input => {
                currentTotalVolume += parseFloat(input.value) || 0;
            });

            const totalVolumeFixed = currentTotalVolume.toFixed(2);
            totalTrucksEl.textContent = allTruckInputs.length;
            totalVolumeEl.textContent = totalVolumeFixed;
            actualTotalEl.textContent = totalVolumeFixed;
        }

        // --- 新增車次紀錄 ---
        function addTruckEntry() {
            truckCounter++;
            const truckEntry = document.createElement('div');
            truckEntry.className = 'truck-entry flex items-center bg-gray-700 p-3 rounded-lg gap-3';
            truckEntry.innerHTML = `
                <span class="font-bold text-gray-300 w-16 text-center text-lg">車次 ${truckCounter}</span>
                <input type="number" step="0.01" placeholder="方數" class="truck-volume-input flex-grow bg-gray-800 border-gray-600 rounded-md p-3 text-center text-white font-bold text-xl focus:ring-2 focus:ring-cyan-500 focus:outline-none">
                <span class="text-gray-400 text-lg">M³</span>
                <button class="delete-btn bg-red-600 hover:bg-red-700 text-white p-3 rounded-md"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button>
            `;
            truckListContainer.appendChild(truckEntry);
            truckListContainer.scrollTop = truckListContainer.scrollHeight;

            const newInput = truckEntry.querySelector('.truck-volume-input');
            newInput.addEventListener('input', updateTotals);
            newInput.focus();

            truckEntry.querySelector('.delete-btn').addEventListener('click', () => {
                truckEntry.remove();
                updateTotals();
            });
            updateTotals();
        }
        
        // --- 鎖定/解鎖資訊欄 ---
        function toggleInfoLock() {
            isInfoLocked = !isInfoLocked;
            const infoInputs = mainInfoSection.querySelectorAll('.info-input');
            
            if (isInfoLocked) {
                mainInfoSection.classList.add('space-y-2');
                mainInfoSection.classList.remove('space-y-4');
                infoInputs.forEach(input => input.readOnly = true);
                toggleLockBtn.innerHTML = lockIcon;
            } else {
                mainInfoSection.classList.add('space-y-4');
                mainInfoSection.classList.remove('space-y-2');
                infoInputs.forEach(input => input.readOnly = false);
                toggleLockBtn.innerHTML = unlockIcon;
            }
        }

        // --- 顯示/隱藏 Modal ---
        function showModal() {
            copyPreviewModal.style.display = 'flex';
        }
        function hideModal() {
            copyPreviewModal.style.display = 'none';
        }

        // --- 事件監聽器 ---
        addTruckBtn.addEventListener('click', addTruckEntry);
        toggleLockBtn.addEventListener('click', toggleInfoLock);
        closeModalBtn.addEventListener('click', hideModal);
        cancelCopyBtn.addEventListener('click', hideModal);

        endTimeEl.addEventListener('input', () => {
            if (endTimeEl.value) {
                actualTotalContainer.classList.remove('hidden');
            } else {
                actualTotalContainer.classList.add('hidden');
            }
        });

        resetBtn.addEventListener('click', () => {
            if (confirm('您確定要清空所有車次紀錄嗎？')) {
                truckListContainer.innerHTML = '';
                truckCounter = 0;
                updateTotals();
            }
        });

        copyBtn.addEventListener('click', () => {
            const date = reportDateEl.value ? new Date(reportDateEl.value).toLocaleDateString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit' }) : 'N/A';
            const location = locationEl.value || 'N/A';
            const startTime = startTimeEl.value || 'N/A';
            const estimatedTotal = estimatedTotalEl.value || 'N/A';
            const endTime = endTimeEl.value;
            
            const currentTrucks = totalTrucksEl.textContent;
            const currentVolume = totalVolumeEl.textContent;

            let reportText;
            if (endTime) {
                reportText = `
--- 混凝土澆置【已完成】---
日期: ${date}
澆置位置: ${location}
--------------------
開始時間: ${startTime}
完成時間: ${endTime}
--------------------
預計總數: ${estimatedTotal} M³
實際總數: ${currentVolume} M³
總車次: ${currentTrucks} 車
                `.trim();
            } else {
                reportText = `
--- 混凝土澆置【回報】---
日期: ${date}
澆置位置: ${location}
--------------------
開始時間: ${startTime}
本日預計: ${estimatedTotal} M³
--------------------
目前進度:
➡️ 累積出車: ${currentTrucks} 車
➡️ 累積澆置: ${currentVolume} M³
                `.trim();
            }
            reportPreviewContent.textContent = reportText;
            showModal();
        });
        
        confirmCopyBtn.addEventListener('click', () => {
            const reportText = reportPreviewContent.textContent;
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = reportText;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            try {
                document.execCommand('copy');
                const originalText = confirmCopyBtn.textContent;
                confirmCopyBtn.textContent = '已複製！';
                confirmCopyBtn.classList.remove('bg-cyan-600');
                confirmCopyBtn.classList.add('bg-green-500');
                setTimeout(() => {
                    confirmCopyBtn.textContent = originalText;
                    confirmCopyBtn.classList.remove('bg-green-500');
                    confirmCopyBtn.classList.add('bg-cyan-600');
                    hideModal();
                }, 1500);
            } catch (err) {
                console.error('複製失敗: ', err);
                alert('複製失敗，您的瀏覽器可能不支援此功能。');
            }
            document.body.removeChild(tempTextArea);
        });

        // --- 初始載入 ---
        initializeApp();
        updateTotals();
    </script>
</body>
</html>
